<!DOCTYPE html>
<header></header>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>iAverage âš¬ Home</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styleNavbar.css" />
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
</head>

<body>
    <!--navbar-->
    <nav class="navbar">
        <div>
            <a id="navLogo" href="/index.html">
                iAverage
            </a>
            <br />
            <p id="navSlogan">
                Calculating your future
            </p>
        </div>
        <ul class="navlist">
            <li class="navlistItem">
                <a href="/index.html">Home</a>
            </li>
            <li class="navlistItem">
                <a href="/account.html">My Account</a>
            </li>
            <li class="navlistItem">
                <a href="/aboutUs.html">About Us</a>
            </li>
        </ul>
    </nav>
<div class="page_format">
    <div class="row">
        <div class="stock_calc">
    <div class="calc_container" float="left">
        <h1 class="calc_label">Calculator</h1>
        <form class="stock_input">
                        <div class="dropdown">
                            <select id="locality-dropdown" name="locality">
                            </select>
                            </div>
                        <label for="name">Currently Owned Shares</label>
                        <br />
            
                        <input type="text" id="curr_shares" name="curr_shares" required
                               minlength="4" maxlength="8" size="10">
                        <br />
                        <label for="name">Average Price of Shares</label>
                        <br />
            
                        <input type="text" id="avg_price" name="avg_price" required
                               minlength="4" maxlength="8" size="10">
                        <br />
                        <label for="name">New Shares Being Purchased</label>
                        <br />
                        <input type="text" id="new_shares" name="new_shares" required
                               minlength="4" maxlength="8" size="10">
                        <br />
                       
                        <label for="name">Final Average Cost</label>
                        <br />
            
                        <input type="text" id="fin_avg_cost" name="fin_avg_cost" required
                               minlength="4" maxlength="8" size="10">
        
                    </form>
                    <br />
                    <br />
                    <button type="button" onclick="getAverage()">Calculate</button>
                </div>
                </div>
                <div class="stock_info">
                    <table class="stock_table">
                        <tr>
                            <th>Stock Company: </th>
                            <th id="comp_name"></th>
                        </tr>
                        <tbody>
                        <tr>
                            <td>Symbol: </td>
                            <td id="comp_symbol"></td>
                        </tr>
                        <tr>
                            <td>Currency: </td>
                            <td id="currency"></td>
                        </tr>
                        <tr>
                            <td>Previous Close: </td>
                            <td id="prev_close"></td>
                        </tr>
                        <tr>
                            <td>Price Range: </td>
                            <td id="price_range"></td>
                        </tr>
                        <tr>
                            <td>Average Volume: </td>
                            <td id="avg_volume"></td>
                        </tr>
                        <tr>
                            <td>Exchange: </td>
                            <td id="exchange"></td>
                        </tr>
                    </tbody>
                    </table>
                    <a href="https://www.google.com/finance/" id="google_link">More Info</a>
            
            </div>
            
            
        </div>
       
    </div>
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>

       const compName = document.getElementById('comp_name');
       const compSymbol = document.getElementById('comp_symbol');
       const curr = document.getElementById('currency');
       const prevClose = document.getElementById('prev_close');
       const priceRange = document.getElementById('price_range');
       const avgVolume = document.getElementById('avg_volume');
       const exchange = document.getElementById('exchange');
                                                 
                                                        let dropdown = document.getElementById('locality-dropdown');
                                                        dropdown.length = 0;

        let defaultOption = document.createElement('option');
        defaultOption.text = 'Choose Stock Company';

        dropdown.add(defaultOption);
        dropdown.selectedIndex = 0;

        const url = 'https://pkgstore.datahub.io/core/s-and-p-500-companies/constituents_json/data/297344d8dc0a9d86b8d107449c851cc8/constituents_json.json';
        // let priceURL = 'https://api.twelvedata.com/price?symbol=&apikey=60c2faf9f35740b7830c1fcdc3e12a8c';

        const request = new XMLHttpRequest();

        function getInfo(request) {

            request.open('GET', url, true);

            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    console.log(data);
                    let option;
                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        option.text = data[i].Name;
                        //console.log(option.text);
                        option.value = data[i].Symbol;
                        
                        dropdown.add(option);
                    }
                } else {
                    // Reached the server, but it returned an error
                }
            }
            
            request.onerror = function () {
                console.error('An error occurred fetching the JSON from ' + url);
            };
            
            return request.send();
        }
        function getPriceInfo(request) {
            
            request.open('GET', priceURL, true);
            
            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    console.log(data);
                    let option;
                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        //option.text = data[i].Name;
                        //console.log(option.text);
                        option.value = data[i].price;
                        
                        dropdown.add(option);
                    }
                } else {
                    // Reached the server, but it returned an error
                }
            }
            
            request.onerror = function () {
                console.error('An error occurred fetching the JSON from ' + url);
            };
            
            return request.send();
        }
        let quoteURL;
        let finURL;
        getInfo(request);
        function getAverage() {
            let shares = parseFloat(document.getElementById('curr_shares').value);
            let avgPrice = parseFloat(document.getElementById('avg_price').value);
            let stockComp = document.getElementById('locality-dropdown').value;
            let newShares = parseFloat(document.getElementById('new_shares').value);
            let newSharePrice;
            let priceURL = 'https://api.twelvedata.com/price?symbol=' + stockComp + '&apikey=60c2faf9f35740b7830c1fcdc3e12a8c'
            quoteURL = 'https://api.twelvedata.com/quote?symbol='+stockComp+'&apikey=60c2faf9f35740b7830c1fcdc3e12a8c&source=docs';
           // finURL = 'https://www.google.com/finance/quote/'+stockComp+':NASDAQ?sa=X&ved=2ahUKEwiOrMXP1o_7AhXMk2oFHQXZCEAQ3ecFegQIHRAi';
            const req = new XMLHttpRequest();
            request.open('GET', priceURL, true);
            let option;
            let finAvg;
            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    console.log(data);
                    
                    option = document.createElement('option');
                    
                    newSharePrice = parseFloat(data.price);
                    
                    finAvg = document.getElementById('fin_avg_cost').value = ((shares + avgPrice) + (newShares + newSharePrice)) / (shares + newShares);
                    console.log(finAvg);
                    
                    dropdown.add(option);
                    getQuote();
                    $('#google_link').attr('href', finURL);
                    
                } else {
                    // Reached the server, but it returned an error
                }
            }
            
            request.onerror = function () {
                console.error('An error occurred fetching the JSON from ' + url);
            };
            
            request.send();
            
        }
        function getQuote(){
            const req = new XMLHttpRequest();
            request.open('GET', quoteURL, true);
            
            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    console.log(data.exchange);
                    compName.innerHTML = data.name;
                    compSymbol.innerHTML = data.symbol;
                    curr.innerHTML = data.currency;
                    prevClose.innerHTML = data.previous_close;
                    avgVolume.innerHTML = data.average_volume;
                    priceRange.innerHTML = data.low+'-'+data.high;
                    exchange.innerHTML = data.exchange;
                    finURL = 'https://www.google.com/finance/quote/'+stockComp+':'+exchange+'?sa=X&ved=2ahUKEwiOrMXP1o_7AhXMk2oFHQXZCEAQ3ecFegQIHRAi';
                    
                    
                    
                } else {
                    // Reached the server, but it returned an error
                }
            }
            
            request.onerror = function () {
                console.error('An error occurred fetching the JSON from ' + url);
            };
            
            request.send();
        }

    </script>

</body>
</html>