<!DOCTYPE html>
<header></header>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>iAverage âš¬ Home</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styleNavbar.css" />
</head>

<body>
    <!--navbar-->
    <nav class="navbar">
        <div>
            <a id="navLogo" href="/index.html">
                iAverage
            </a>
            <br />
            <p id="navSlogan">
                Calculating your future
            </p>
        </div>
        <ul class="navlist">
            <li class="navlistItem">
                <a href="/index.html">Home</a>
            </li>
            <li class="navlistItem">
                <a href="/account.html">My Account</a>
            </li>
            <li class="navlistItem">
                <a href="/aboutUs.html">About Us</a>
            </li>
        </ul>
    </nav>

    <div class="container">
        <div class="dropdown">
            
            <select id="locality-dropdown" name="locality">
            </select>
            <br />
            <label for="name">Currently Owned Shares</label>
            <br />

            <input type="text" id="curr_shares" name="curr_shares" required
                   minlength="4" maxlength="8" size="10">
            <br />
            <label for="name">Average Price of Shares</label>
            <br />

            <input type="text" id="avg_price" name="avg_price" required
                   minlength="4" maxlength="8" size="10">
            <br />
            <label for="name">New Shares Being Purchased</label>
            <br />
            <input type="text" id="new_shares" name="new_shares" required
                   minlength="4" maxlength="8" size="10">
            <br />
           
            <label for="name">Final Average Cost</label>
            <br />

            <input type="text" id="fin_avg_cost" name="fin_avg_cost" required
                   minlength="4" maxlength="8" size="10">
            <br />
            <button type="button" onclick="getAverage()">Calculate</button>
        </div>
    </div>
    <script>
       

        let dropdown = document.getElementById('locality-dropdown');
        dropdown.length = 0;

        let defaultOption = document.createElement('option');
        defaultOption.text = 'Choose Stock Company';

        dropdown.add(defaultOption);
        dropdown.selectedIndex = 0;

        const url = 'https://pkgstore.datahub.io/core/s-and-p-500-companies/constituents_json/data/297344d8dc0a9d86b8d107449c851cc8/constituents_json.json';
        // let priceURL = 'https://api.twelvedata.com/price?symbol=&apikey=60c2faf9f35740b7830c1fcdc3e12a8c';

        const request = new XMLHttpRequest();

        function getInfo(request) {

            request.open('GET', url, true);

            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    console.log(data);
                    let option;
                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        option.text = data[i].Name;
                        //console.log(option.text);
                        option.value = data[i].Symbol;

                        dropdown.add(option);
                    }
                } else {
                    // Reached the server, but it returned an error
                }
            }

            request.onerror = function () {
                console.error('An error occurred fetching the JSON from ' + url);
            };

            return request.send();
        }
        function getPriceInfo(request) {

            request.open('GET', priceURL, true);

            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    console.log(data);
                    let option;
                    for (let i = 0; i < data.length; i++) {
                        option = document.createElement('option');
                        //option.text = data[i].Name;
                        //console.log(option.text);
                        option.value = data[i].price;

                        dropdown.add(option);
                    }
                } else {
                    // Reached the server, but it returned an error
                }
            }

            request.onerror = function () {
                console.error('An error occurred fetching the JSON from ' + url);
            };

            return request.send();
        }
        getInfo(request);
        function getAverage() {
            let shares = parseFloat(document.getElementById('curr_shares').value);
            let avgPrice = parseFloat(document.getElementById('avg_price').value);
            let stockComp = document.getElementById('locality-dropdown').value;
            let newShares = parseFloat(document.getElementById('new_shares').value);
            let newSharePrice;
            let priceURL = 'https://api.twelvedata.com/price?symbol=' + stockComp + '&apikey=60c2faf9f35740b7830c1fcdc3e12a8c'

            const req = new XMLHttpRequest();
            request.open('GET', priceURL, true);
            let option;
            let finAvg;
            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    console.log(data);

                    option = document.createElement('option');

                    newSharePrice = parseFloat(data.price);
                    
                   finAvg = document.getElementById('fin_avg_cost').value = ((shares + avgPrice) + (newShares + newSharePrice)) / (shares + newShares);
                    console.log(finAvg);

                    dropdown.add(option);

                } else {
                    // Reached the server, but it returned an error
                }
            }

            request.onerror = function () {
                console.error('An error occurred fetching the JSON from ' + url);
            };

            request.send();
            
        }
    </script>

</body>
</html>